#!/bin/bash

add() {
    cp -r $* './BUFFER'
}

list() {
    if [[ -n $1 ]]; then
        tree -a --noreport topic.*
    else
        tree -a --noreport topic.[!_]*
    fi
}

_prefix() {
    case $1 in
        topic.*) echo $1 ;;
        *) echo "topic.$1" ;;
    esac
}

save() {
    mv "./BUFFER/*" "./BUFFER/*" `_prefix $1`
}

_green() {
    echo -e "\033[32m$1\033[0m"
}

apply() {
    local f after permit
    local topic=`_prefix $1`
    local -a files=(`find $topic -not -type d`)
    for f in ${files[@]}; do
        case $f in
            $topic/ROOT/*) _green ${f#"$topic/ROOT"} ;;
            $topic/*) _green '~/'${f#"$topic/"} ;;
        esac
    done
    read -p "Process? [Y/n] " permit
    case $permit in
        Y|y|[Yy][Ee][Ss]) ;;
        *) echo "Aborted."; exit 1 ;;
    esac
    for f in ${files[@]}; do
        case $f in
            $topic/ROOT/*) after=${f#"$topic/ROOT"} ;;
            $topic/*) after=$HOME/${f#"$topic/"} ;;
        esac
        # absolute path
        ln -sf `readlink -f $f` $after
    done
}



: << EOF
for j in $*; do
    case $i in
        -*) ;;
        *) args=(${args[@]} $i) ;;
    esac
done
EOF

main() {
    local todo display_all
    for i in $*; do
        case $i in
            --*)
                case $i in
                    --add) todo=add ;;
                    --save) todo=save ;;
                    --list) todo=list ;;
                    --all) display_all=true ;;
                esac
            ;;
            -*)
                i=${i:1}
                for ((j=0; j<${#i}; j++)); do
                    case ${i:$j:$j+1} in
                        a) todo=add ;;
                        s) todo=status_ ;;
                        S) todo=save ;;
                        l) todo=list ;;
                        A) display_all=true ;;
                    esac
                done
            ;;
            *) targets=(${targets[@]} $i) ;;
        esac
    done
    if [[ -z $todo ]]; then
        todo=apply
    fi
    $todo $display_all ${targets[@]}
}

main $*
