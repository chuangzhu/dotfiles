#!/bin/bash

add() {
    # cp -r $* './BUFFER'
    local i; for i in $@; do
        i=`readlink -f $i`
        case $i in
            $HOME/*) local after="./BUFFER${i#$HOME}" ;;
            /*) local after="./BUFFER/ROOT$i"
        esac
        mkdir -p ${after%/*}
        cp -r $i $after
    done
}

list() {
    if [[ $# = 0 ]]; then
        if [[ $display_all ]]; then
            tree -a --noreport topic.*
        else
            tree -a --noreport topic.[!_]*
        fi
    else
        tree -a --noreport `_prefix $*`
    fi
}

_prefix() {
    local topic
    for topic in $*; do
        case $topic in
            topic.*) echo $topic ;;
            *) echo "topic.$topic" ;;
        esac
    done
}

save() {
    if [[ $# != 1 ]]; then
        echo "Save: to many arguments."
        exit 1
    fi
    local saveto=`_prefix $1`
    if ! [[ -d $saveto ]]; then
        mkdir $saveto
    fi
    find "./BUFFER" -not -type d -exec mv {} $saveto \;
}

_green() {
    echo -e "\033[32m$1\033[0m"
}

apply() {
    local files=(`find $(_prefix $*) -not -type d`) afters=()
    local f; for f in ${files[@]}; do
        case $f in
            topic.*/ROOT/*)
                after=${f#topic.*/ROOT}
                _green $after
            ;;
            topic.*/*)
                 after=$HOME/${f#topic.*/}
                _green '~/'${f#topic.*/}
            ;;
        esac
        afters=(${afters[@]} $after)
    done
    local permit; read -p "Process? [Y/n] " permit
    case $permit in
        Y | y | [Yy][Ee][Ss] | '') ;;
        *) echo "Aborted."; exit 1 ;;
    esac
    local i; for i in ${!files[@]}; do
        # absolute path
        ln -sf `readlink -f ${files[$i]}` ${afters[$i]}
    done
}

status_() {
    if [[ -d 'BUFFER' ]]; then
        tree -a --noreport 'BUFFER'
    else
        echo 'Nothing in the BUFFER.'
    fi
}



main() {
    local todo
    while true; do
        # _green $1
        case $1 in
            -a | --add) todo=add; shift ;;
            -S | --save) todo=save; shift ;;
            -s | --status) todo=status_; shift ;;
            -l | --list) todo=list; shift ;;
            -A | --all) display_all='true'; shift ;;
            --) shift; break ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done
    if [[ -z $todo ]]; then
        if [[ $# = 0 ]]; then
            exit 1
        fi
        todo=apply
    fi
    $todo $@
}

main `getopt -u \
    -o aSslA \
    -l add,save,status,list,all \
    -- "$@"
`
